{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Historique m√©t√©o - Jardin bIOT{% endblock %}

{% block extrahead %}
<style>
  .weather-dashboard { max-width: 1000px; }
  .weather-garden-card {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1rem 1.5rem;
    margin-bottom: 1.5rem;
    background: #fff;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  .weather-garden-card h3 { margin-top: 0; color: #417690; }
  .weather-alert {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 6px;
    padding: 1rem;
    margin: 1rem 0;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
  }
  .weather-alert-icon { font-size: 1.5rem; }
  .weather-alert-actions { margin-top: 0.5rem; }
  .weather-alert-actions a, .weather-alert-actions button {
    margin-right: 0.5rem;
    padding: 0.35rem 0.75rem;
    font-size: 0.9em;
  }
  .weather-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
  }
  .weather-table th, .weather-table td { padding: 0.4rem 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
  .weather-table th { background: #f8f9fa; color: #555; font-weight: 600; }
  .weather-table .temp-high { color: #c0392b; }
  .weather-table .temp-low { color: #3498db; }
  .weather-table .precip { color: #2980b9; }
  .weather-table .snow { color: #7f8c8d; }
  .weather-summary {
    background: #f0f7ff;
    border-radius: 6px;
    padding: 0.75rem 1rem;
    margin: 0.75rem 0;
    font-weight: 500;
  }
  .sprinkler-zones { margin-top: 1rem; }
  .sprinkler-zone {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    margin-right: 1rem;
    margin-bottom: 0.5rem;
    padding: 0.4rem 0.75rem;
    background: #e8f5e9;
    border-radius: 4px;
    font-size: 0.9em;
  }
  .sprinkler-zone.triggered { background: #c8e6c9; }
  .no-coords { color: #999; font-style: italic; }
  .fetch-btn { margin-bottom: 1rem; }
  .forecast-section { margin-top: 1.5rem; }
  .forecast-section h4 { color: #417690; margin-bottom: 0.5rem; }
  .forecast-alert { padding: 0.6rem 1rem; margin: 0.5rem 0; border-radius: 6px; display: flex; gap: 0.5rem; align-items: flex-start; }
  .forecast-alert.warning { background: #fff3cd; border: 1px solid #ffc107; }
  .forecast-alert.info { background: #e7f3ff; border: 1px solid #3498db; }
  .sprinkler-pause-banner { background: #fff3cd; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; }
</style>
{% endblock %}

{% block content %}
<h1>üìä Historique m√©t√©o</h1>

<p class="fetch-btn">
  <a href="?refresh=1" class="button">Actualiser les donn√©es m√©t√©o</a>
  <span style="color:#666; margin-left:1rem; font-size:0.9em;">
    Historique 14 j + Pr√©vision 7 j. Nouveaux jardins : mise √† jour auto √† la cr√©ation.
  </span>
</p>

{% if sprinkler_force_zone_id %}
<div class="sprinkler-pause-banner">
  <strong>Pluie pr√©vue</strong> ‚Äî Arrosage annul√© automatiquement.
  <form method="post" action="{% url 'trigger_sprinkler' sprinkler_force_zone_id %}" style="display:inline; margin-left:0.5rem;">
    {% csrf_token %}
    <input type="hidden" name="force" value="1">
    <button type="submit" class="button">D√©clencher quand m√™me</button>
  </form>
  <a href="?clear_sprinkler_pause=1" style="margin-left:0.5rem;">Fermer</a>
</div>
{% endif %}

<div class="weather-dashboard">
  {% for garden in gardens %}
  <div class="weather-garden-card">
    <h3>üè° {{ garden.nom }}</h3>
    <p>
      {% if garden.ville %}{{ garden.ville }}{% if garden.pays %}, {{ garden.pays }}{% endif %}{% endif %}
      {% if not garden.a_coordonnees %}
        <span class="no-coords">‚Äî Pas de coordonn√©es (lat/long) : ajoutez-les pour activer la m√©t√©o.</span>
      {% endif %}
    </p>

    {% if garden.alert %}
    <div class="weather-alert">
      <span class="weather-alert-icon">‚ö†Ô∏è</span>
      <div>
        <strong>Alerte arrosage</strong>
        <p>{{ garden.alert.message }}</p>
        <div class="weather-alert-actions">
          {% for zone in garden.sprinkler_zones_actives %}
          <form method="post" action="{% url 'trigger_sprinkler' zone.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="button">üöø {{ zone.nom }}</button>
          </form>
          {% endfor %}
          <a href="{% url 'admin:species_event_add' %}?specimen=" class="button">üìù Noter un arrosage</a>
        </div>
      </div>
    </div>
    {% endif %}

    {% if garden.forecast_alerts %}
    <div class="forecast-section">
      <h4>üìã Alertes pr√©vision</h4>
      {% for a in garden.forecast_alerts %}
      <div class="forecast-alert {{ a.severity }}">
        <span>{% if a.severity == 'warning' %}‚ö†Ô∏è{% else %}‚ÑπÔ∏è{% endif %}</span>
        <span>{{ a.message }}</span>
      </div>
      {% endfor %}
    </div>
    {% endif %}

    {% if garden.a_coordonnees and garden.weather_records_display %}
    {% if garden.moyenne_temp is not None or garden.total_pluie_mm or garden.total_neige_cm %}
    <div class="weather-summary">
      {% if garden.moyenne_temp is not None %}Moyenne 14 j : <strong>{{ garden.moyenne_temp }}¬∞C</strong>{% endif %}
      {% if garden.total_pluie_mm %} ¬∑ Pluie : <strong>{{ garden.total_pluie_mm }} mm</strong>{% endif %}
      {% if garden.total_neige_cm %} ¬∑ Neige : <strong>{{ garden.total_neige_cm }} cm</strong>{% endif %}
    </div>
    {% endif %}
    <table class="weather-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Temp. max</th>
          <th>Temp. min</th>
          <th>Temp. moy</th>
          <th>Pluie</th>
          <th>Neige</th>
        </tr>
      </thead>
      <tbody>
        {% for rec in garden.weather_records_display %}
        <tr>
          <td>{{ rec.date|date:"d/m/Y" }}</td>
          <td class="temp-high">{% if rec.temp_max %}{{ rec.temp_max|floatformat:1 }}¬∞C{% else %}‚Äî{% endif %}</td>
          <td class="temp-low">{% if rec.temp_min %}{{ rec.temp_min|floatformat:1 }}¬∞C{% else %}‚Äî{% endif %}</td>
          <td>{% if rec.temp_mean %}{{ rec.temp_mean|floatformat:1 }}¬∞C{% else %}‚Äî{% endif %}</td>
          <td class="precip">{{ rec.rain_mm|default:0|floatformat:1 }} mm</td>
          <td class="snow">{{ rec.snowfall_cm|default:0|floatformat:1 }} cm</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% elif garden.a_coordonnees %}
    <p style="color:#666;">Aucune donn√©e m√©t√©o. Ex√©cutez <code>python manage.py fetch_weather</code>.</p>
    {% endif %}

    {% if garden.forecast %}
    <div class="forecast-section">
      <h4>üîÆ Pr√©vision 7 jours</h4>
      <table class="weather-table">
        <thead>
          <tr>
            <th>Date</th>
            <th>Temp. max</th>
            <th>Temp. min</th>
            <th>Pluie</th>
            <th>Neige</th>
          </tr>
        </thead>
        <tbody>
          {% for d in garden.forecast %}
          <tr>
            <td>{{ d.date|date:"d/m" }}</td>
            <td class="temp-high">{% if d.temp_max %}{{ d.temp_max|floatformat:0 }}¬∞C{% else %}‚Äî{% endif %}</td>
            <td class="temp-low">{% if d.temp_min %}{{ d.temp_min|floatformat:0 }}¬∞C{% else %}‚Äî{% endif %}</td>
            <td class="precip">{{ d.precipitation_mm|floatformat:0 }} mm</td>
            <td class="snow">{{ d.snowfall_cm|floatformat:0 }} cm</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    {% if garden.sprinkler_zones_actives %}
    <div class="sprinkler-zones">
      <strong>Sprinklers system :</strong>
      {% for zone in garden.sprinkler_zones_actives %}
      <span class="sprinkler-zone">{{ zone.nom }} ({{ zone.duree_defaut_minutes }} min)</span>
      {% endfor %}
    </div>
    {% endif %}
  </div>
  {% empty %}
  <p>Aucun jardin. <a href="{% url 'admin:species_garden_add' %}">Cr√©er un jardin</a> avec adresse et coordonn√©es.</p>
  {% endfor %}
</div>
{% endblock %}
